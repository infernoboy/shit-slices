#!/bin/bash

# Example: slices Snapchat create jed

### VARIABLES

APP_NAME="$1"
ACTION="$2"
SLICE_NAME="$3"
NO_LAUNCH=$4

BUNDLE_ID=""
BUNDLE_PATH=""
EXECUTABLE="$APP_NAME"
DATA_BUNDLE_ID=""
GROUP_BUNDLE_ID=()

ORIG_SLICE_NAME="_original"
MP_ROOT="/private/var/mobile/Documents/Slices"
APP_ROOT="/private/var/containers/Bundle/Application"
APP_GROUP_DATA_ROOT="/private/var/mobile/Containers/Shared/AppGroup"
APP_DATA_ROOT="/private/var/mobile/Containers/Data/Application"
APP_EXTENSIONS_DATA_ROOT="/private/var/mobile/Containers/Data/PluginKitPlugin"

PROFILES="$MP_ROOT/profiles.plist"
APP_DATA_PLIST="/private/var/mobile/slices_app_data.plist"

APP_GROUP_DATA_UUID=()
APP_EXTENSIONS_DATA_UUID=()
APP_DATA_UUID=""

if [ "$1" == "reset" ]; then
    killall cfprefsd 2> /dev/null
    rm -rf "$MP_ROOT"
    echo "Data has been reset"
    exit 0
fi

### FUNCTIONS

function property {    
    if [ ! -f "$1" ]; then
        plutil -create "$1"
    fi

    local PLIST="$1"

    shift

    local OrigKeyPath="$1"
    IFS=":"; local KeyPath=($1); unset IFS
    local DictPath=()

    shift

    for ((i = 0; i < ${#KeyPath[@]}; ++i)); do
        DictPath+=(-key "${KeyPath[$i]}")

        local ValueCheck=$(plutil "${DictPath[@]}" "$PLIST" 2> /dev/null)

        if [[ ( -z "$ValueCheck" && "${#KeyPath[@]}" -ne "$((i + 1))" ) || "$?" -ne "0" ]]; then
            plutil "${DictPath[@]}" -dict "$PLIST" > /dev/null 2>&1
        fi
    done

    if [[ "$1" == "-arrayadd" ]]; then
        shift

        local ValueCheck=$(plutil "${DictPath[@]}" "$PLIST" 2> /dev/null)

        if [[ -z "$ValueCheck" ]]; then
            plutil "${DictPath[@]}" -array "$PLIST" > /dev/null 2>&1
        fi

        if [ "$1" == "-missing" ]; then
            shift

            if propertyStringExistInArray "$PLIST" "$OrigKeyPath" "$1"; then
                return 0
            fi
        fi

        if [[ -z $(plutil "${DictPath[@]}" -arrayadd -string "$@" "$PLIST" 2> /dev/null) ]]; then
            plutil "${DictPath[@]}" -array "$PLIST" > /dev/null 2>&1
            plutil "${DictPath[@]}" -arrayadd -string "$@" "$PLIST" > /dev/null
        fi
    elif [[ "$1" == "-arrayremove" ]]; then
        shift

        local ValueCheck=$(plutil "${DictPath[@]}" "$PLIST" 2> /dev/null)

        if [[ -z "$ValueCheck" ]]; then
            plutil "${DictPath[@]}" -array "$PLIST" > /dev/null 2>&1
        fi

        local CurrentArray=($(propertyToArray "$PLIST" "$OrigKeyPath"))

        property "$PLIST" "$OrigKeyPath" -remove

        for element in "${CurrentArray[@]}"; do
            if [ "$element" != "$1" ]; then
                property "$PLIST" "$OrigKeyPath" -arrayadd "$element"
            fi
        done
    else
        plutil "${DictPath[@]}" "$@" "$PLIST"
    fi
}

function propertyExist {
    if [ ! -f "$1" ]; then
        plutil -create "$1"
    fi

    local PLIST="$1"

    shift

    IFS=":"; local KeyPath=($1); unset IFS
    local DictPath=()

    shift

    for ((i = 0; i < ${#KeyPath[@]}; ++i)); do
        DictPath+=(-key "${KeyPath[$i]}")
    done

    if [[ -z $(plutil "${DictPath[@]}" "$PLIST" 2> /dev/null) ]]; then
        return 1
    else
        return 0
    fi
}

function propertyToArray {
    local prop=$(property "$1" "$2" 2> /dev/null)
    local arr=()
    local fixedEntry=""

    for entry in $prop
    do
        if [ "$entry" != "(" ] && [ "$entry" != ")" ]; then
            fixedEntry=$(tr -d '"' <<< "$entry")
            fixedEntry="${fixedEntry//','/''}"

            arr+=("$fixedEntry")
        fi
    done

    echo "${arr[@]}"
}

function propertyStringExistInArray {
    if propertyExist "$1" "$2"; then
        local elements=($(propertyToArray "$1" "$2"))

        for element in "${elements[@]}"; do
            if [ "$element" == "$3" ]; then
                return 0
            fi
        done

        return 1
    else
        return 1
    fi
}

function validate {
    echo "App: $APP_NAME"

    if [ "$ACTION" == "create" ]; then
        if [[ -z "$SLICE_NAME" ]]; then
            echo "Missing slice name"
            exit 1
        fi

        if [ "$SLICE_NAME" == "$ORIG_SLICE_NAME" ]; then
            echo "Cannot use $ORIG_SLICE_NAME as slice name!"

            exit 1
        fi

        echo "Creating slice: $SLICE_NAME"
    elif [ "$ACTION" == "apply" ]; then
        if [[ -z "$SLICE_NAME" ]]; then
            echo "Missing slice name"
            exit 1
        fi

        echo "Applying slice: $SLICE_NAME"
    elif [ "$ACTION" == "original" ]; then
        echo "Applying original slice..."

        $0 "$APP_NAME" apply "$ORIG_SLICE_NAME" "$SLICE_NAME"
    elif [ "$ACTION" == "clean" ]; then
        echo "Removing all slices..."
    elif [ "$ACTION" == "remove" ]; then
        if [[ -z "$SLICE_NAME" ]]; then
            echo "Missing slice name"
            exit 1
        fi

        echo "Removing slice: $SLICE_NAME"
    else
        setup

        exit 1
    fi
}

function defineBundleIds {
    echo "Searching for app..."

    for ROOT_FOLDER in "$APP_ROOT"/*; do
        if [ -d "$ROOT_FOLDER" ]; then
            for APP_FOLDER in "$ROOT_FOLDER"/*; do
                if [ -d "$APP_FOLDER" ]; then
                    if [[ "$APP_FOLDER" = *".app" ]]; then
                        if [ -f "$APP_FOLDER/Info.plist" ]; then
                            local CFBundleName=$(plutil -key CFBundleName "$APP_FOLDER/Info.plist" 2> /dev/null)
                           
                            if [ "$APP_NAME" == "$CFBundleName" ]; then
                                BUNDLE_ID="$(plutil -key CFBundleIdentifier "$APP_FOLDER/Info.plist")"
                                EXECUTABLE="$(plutil -key CFBundleExecutable "$APP_FOLDER/Info.plist")"
                                BUNDLE_PATH="$APP_FOLDER"

                                break
                            fi
                            
                            local CFBundleDisplayName=$(plutil -key CFBundleDisplayName "$APP_FOLDER/Info.plist" 2> /dev/null)
                           
                           if [ "$APP_NAME" == "$CFBundleDisplayName" ]; then
                                BUNDLE_ID="$(plutil -key CFBundleIdentifier "$APP_FOLDER/Info.plist")"
                                EXECUTABLE="$(plutil -key CFBundleExecutable "$APP_FOLDER/Info.plist")"
                                BUNDLE_PATH="$APP_FOLDER"

                                break
                            fi
                        fi
                    fi
                fi
            done
        fi
    done

    if [[ -z "$BUNDLE_ID" ]]; then
        echo "Could not find bundle ID for app."

        exit 1
    fi

    BundleProfile="Profile:${BUNDLE_ID}"

    # get others from stored plist lookups
    if [ -f "$APP_DATA_PLIST" ]; then
        DATA_BUNDLE_ID=$(plutil -key "$APP_NAME" "$APP_DATA_PLIST" 2> /dev/null)
    fi

    # load app group IDs used by app
    local TMP_APP_ENTITLEMENTS="/private/var/tmp/$EXECUTABLE.entitlements"

    ldid -e "$BUNDLE_PATH/$EXECUTABLE" > "$TMP_APP_ENTITLEMENTS"

    local TMP_GROUPS=$(plutil -key "com.apple.security.application-groups" "$TMP_APP_ENTITLEMENTS" 2> /dev/null)

    local temp_group

    for group in $TMP_GROUPS
    do
        if [ "$group" != "(" ] && [ "$group" != ")" ]; then
            temp_group="${group//','/''}"  
            temp_group="${temp_group%\"}"
            temp_group="${temp_group#\"}"
            GROUP_BUNDLE_ID+=("${temp_group}")
        fi
            
    done

    rm "$TMP_APP_ENTITLEMENTS"
}

function setup {
    # create base
    mkdir -p "$MP_ROOT"
    chown mobile:mobile "$MP_ROOT"
} 

function defineAppPaths {
    # Loop folders in APP_GROUP_DATA_ROOT, APP_EXTENSIONS_DATA_ROOT, and APP_DATA_ROOT 
    # then locate MCMMetadataIdentifier in 
    # the .com.apple.mobile_container_manager.metadata plist file
    
    local metadata=".com.apple.mobile_container_manager.metadata.plist"

    echo "Searching for shared data..."

    for APP_FOLDER in "$APP_GROUP_DATA_ROOT"/*; do
        if [ -d "$APP_FOLDER" ]; then
            if [ -f "$APP_FOLDER/$metadata" ]; then
                local this_bundle_id=$(plutil -key MCMMetadataIdentifier "$APP_FOLDER/$metadata" 2> /dev/null)

                for id in "${GROUP_BUNDLE_ID[@]}" #loop all group bundles
                do
                    if [ "$id" == "$this_bundle_id" ] || [ "$BUNDLE_ID" == "$this_bundle_id" ] || [[ "$this_bundle_id" == *"$BUNDLE_ID" ]]; then
                        APP_GROUP_DATA_UUID+=("$(basename "$APP_FOLDER")")
                    fi
                done
            fi
        fi
    done


    echo "Searching for extension data..."

    for APP_FOLDER in "$APP_EXTENSIONS_DATA_ROOT"/*; do
        if [ -d "$APP_FOLDER" ]; then
            if [ -f "$APP_FOLDER/$metadata" ]; then
                local this_bundle_id=$(plutil -key MCMMetadataInfo -key "com.apple.MobileInstallation.ParentBundleID" "$APP_FOLDER/$metadata" 2> /dev/null)

                if [ "$DATA_BUNDLE_ID" == "$this_bundle_id" ] || [ "$BUNDLE_ID" == "$this_bundle_id" ]; then
                    APP_EXTENSIONS_DATA_UUID+=("$(basename "$APP_FOLDER")")
                fi
            fi
        fi
    done

    echo "Searching for app data..."

    for APP_FOLDER in "$APP_DATA_ROOT"/*; do
        if [ -d "$APP_FOLDER" ]; then
            if [ -f "$APP_FOLDER/$metadata" ]; then
                local this_bundle_id=$(plutil -key MCMMetadataIdentifier "$APP_FOLDER/$metadata" 2> /dev/null)
                local fld=$(basename "$APP_FOLDER")

                if [ "$DATA_BUNDLE_ID" == "$this_bundle_id" ] || [ "$BUNDLE_ID" == "$this_bundle_id" ]; then
                    APP_DATA_UUID="$fld"
                fi
            fi
        fi
    done

    if [[ -z "$APP_DATA_UUID" ]]; then
        echo "Couldn't find app data!"

        exit 1
    fi
}

function debugVars {
    echo "APP_NAME: $APP_NAME"
    echo "EXECUTABLE: $EXECUTABLE"
    echo "ACTION: $ACTION"
    echo "SLICE_NAME: $SLICE_NAME"
    echo "BUNDLE_ID: $BUNDLE_ID"
    echo "BUNDLE_PATH: $BUNDLE_PATH"
    echo "DATA_BUNDLE_ID: $DATA_BUNDLE_ID"
    echo "GROUP_BUNDLE_ID: ${GROUP_BUNDLE_ID[@]}"

    echo "PLIST: $PLIST"
    echo "APP_DATA_PLIST: $APP_DATA_PLIST"

    echo "APP_GROUP_DATA_UUID: $APP_GROUP_DATA_UUID"
    echo "APP_DATA_UUID: $APP_DATA_UUID"
    echo "APP_EXTENSIONS_DATA_UUID: ${APP_EXTENSIONS_DATA_UUID[@]}"
}

function hasSlice {
    if propertyStringExistInArray "$PROFILES" "${BundleProfile}:Slices" "$1"; then
        return 0
    else
        return 1
    fi
}

function backupData {
    killall cfprefsd 2> /dev/null

    echo "Backing up slice: $1"

    local ProfilePath="$MP_ROOT/$BUNDLE_ID/slice.$1"

    echo "- Backing up shared data..."

    for UUID in "${APP_GROUP_DATA_UUID[@]}"
    do
        local GroupPath="$ProfilePath/Groups/$UUID"

        rm -rf "$GroupPath"
        mkdir -p "$GroupPath"
        cp -a "$APP_GROUP_DATA_ROOT/$UUID/." "$GroupPath"
        chown -R mobile:mobile "$GroupPath"
    done

    echo "- Backing up extension data..."

    for UUID in "${APP_EXTENSIONS_DATA_UUID[@]}"
    do
        local ExtensionPath="$ProfilePath/Extensions/$UUID"

        rm -rf "$ExtensionPath"
        mkdir -p "$ExtensionPath"
        cp -a "$APP_EXTENSIONS_DATA_ROOT/$UUID/." "$ExtensionPath"
        chown -R mobile:mobile "$ExtensionPath"
    done

    echo "- Backing up app data..."

    local DataPath="$ProfilePath/Data/$APP_DATA_UUID"

    if [[ ! -z "$APP_DATA_UUID" ]]; then
        rm -rf "$DataPath"
        mkdir -p "$DataPath"
        cp -a "$APP_DATA_ROOT/$APP_DATA_UUID/." "$DataPath"
        chown -R mobile:mobile "$DataPath"
    fi

    echo "- Finished backing up slice $1"
}

function restoreData {
    killall cfprefsd 2> /dev/null

    echo "Restoring slice: $1"

    if ! hasSlice "$1"; then
        echo "There is no slice named $1 for app."
        exit 1
    fi

    local ProfilePath="$MP_ROOT/$BUNDLE_ID/slice.$1"

    echo "- Restoring shared data..."

    APP_GROUP_DATA_UUID=($(propertyToArray "$PROFILES" "${BundleProfile}:Groups"))

    for UUID in "${APP_GROUP_DATA_UUID[@]}"; do
        local GroupPath="$ProfilePath/Groups/$UUID"

        if [ ! -d "$GroupPath" ]; then
            echo "Group data missing at path: $GroupPath"
            exit 1
        fi

        rm -rf "$APP_GROUP_DATA_ROOT/$UUID"
        mkdir -p "$APP_GROUP_DATA_ROOT/$UUID"
        cp -a "$GroupPath/." "$APP_GROUP_DATA_ROOT/$UUID"
        chown -R mobile:mobile "$APP_GROUP_DATA_ROOT/$UUID"
    done

    echo "- Restoring extension data..."

    APP_EXTENSIONS_DATA_UUID=($(propertyToArray "$PROFILES" "${BundleProfile}:Extensions"))

    for UUID in "${APP_EXTENSIONS_DATA_UUID[@]}"; do
        local ExtensionPath="$ProfilePath/Extensions/$UUID"

        if [ ! -d "$ExtensionPath" ]; then
            echo "Extension data missing at path: $ExtensionPath"
            exit 1
        fi

        rm -rf "$APP_EXTENSIONS_DATA_ROOT/$UUID"
        mkdir -p "$APP_EXTENSIONS_DATA_ROOT/$UUID"
        cp -a "$ExtensionPath/." "$APP_EXTENSIONS_DATA_ROOT/$UUID"
        chown -R mobile:mobile "$APP_EXTENSIONS_DATA_ROOT/$UUID"
    done

    echo "- Restoring app data..."

    APP_DATA_UUID=$(property "$PROFILES" "${BundleProfile}:Data")

    if [[ ! -z "$APP_DATA_UUID" ]]; then
        local DataPath="$ProfilePath/Data/$APP_DATA_UUID"

        if [ ! -d "$DataPath" ]; then
            echo "App data missing at path: $DataPath"
            exit 1
        fi

        rm -rf "$APP_DATA_ROOT/$APP_DATA_UUID"
        mkdir -p "$APP_DATA_ROOT/$APP_DATA_UUID"
        cp -a "$DataPath/." "$APP_DATA_ROOT/$APP_DATA_UUID"
        chown -R mobile:mobile "$APP_DATA_ROOT/$APP_DATA_UUID"
    fi

    echo "- Finished restoring slice $1"
}

validate
setup 

if [ "$ACTION" == "create" ]; then
    defineBundleIds

    if hasSlice "$SLICE_NAME"; then
        echo "Slice already exist: $SLICE_NAME"

        exit 1
    fi

    defineAppPaths 

    killall "$EXECUTABLE" 2> /dev/null

    property "$PROFILES" "BundleID:${APP_NAME}" -string "$BUNDLE_ID"

    property "$PROFILES" "${BundleProfile}:AppName" -string "$APP_NAME"
    property "$PROFILES" "${BundleProfile}:BundlePath" -string "$BUNDLE_PATH"
    property "$PROFILES" "${BundleProfile}:Executable" -string "$EXECUTABLE"
    
    GroupItems=${#APP_GROUP_DATA_UUID[@]}

    if [[ ! -z "$GroupItems" ]]; then
        for UUID in "${APP_GROUP_DATA_UUID[@]}"; do
            property "$PROFILES" "${BundleProfile}:Groups" -arrayadd -missing "$UUID"
        done            
    fi

    ExtensionItems=${#APP_EXTENSIONS_DATA_UUID[@]}

    if [[ ! -z "$ExtensionItems" ]]; then
        for UUID in "${APP_EXTENSIONS_DATA_UUID[@]}"; do
            property "$PROFILES" "${BundleProfile}:Extensions" -arrayadd -missing "$UUID"
        done
    fi

    if [[ ! -z "$APP_DATA_UUID" ]]; then
        property "$PROFILES" "${BundleProfile}:Data" -string "$APP_DATA_UUID"
    fi

    if ! hasSlice "$ORIG_SLICE_NAME"; then
        echo "Creating original slice for $APP_NAME"

        property "$PROFILES" "${BundleProfile}:Slices" -arrayadd -missing "$ORIG_SLICE_NAME"

        backupData "$ORIG_SLICE_NAME"
    else
        backupData "$(property "$PROFILES" "ActiveSlice:${BUNDLE_ID}")"
    fi

    property "$PROFILES" "${BundleProfile}:Slices" -arrayadd -missing "$SLICE_NAME"
    property "$PROFILES" "ActiveSlice:${BUNDLE_ID}" -string "$SLICE_NAME"

    backupData "$SLICE_NAME"

    echo "Slice $SLICE_NAME is now active for app."

    exit 0
fi

if [ "$ACTION" == "apply" ]; then
    if ! propertyExist "$PROFILES" "BundleID:${APP_NAME}"; then
        echo "There is no saved data for app."
        exit 1
    fi

    BUNDLE_ID=$(property "$PROFILES" "BundleID:${APP_NAME}")
    BundleProfile="Profile:${BUNDLE_ID}"
    ACTIVE_SLICE=$(property "$PROFILES" "ActiveSlice:${BUNDLE_ID}")

    if [ "$ACTIVE_SLICE" == "$SLICE_NAME" ]; then
        echo "Slice $SLICE_NAME is already applied"
        
        if [[ -z "$NO_LAUNCH" ]]; then
            activator send "$BUNDLE_ID"
        fi
        
        exit 1
    fi

    if ! hasSlice "$SLICE_NAME"; then
        echo "There is no slice named $SLICE_NAME for app."

        exit 1
    fi

    EXECUTABLE=$(property "$PROFILES" "${BundleProfile}:Executable")
    
    APP_DATA_UUID=$(property "$PROFILES" "${BundleProfile}:Data")
    APP_GROUP_DATA_UUID=($(propertyToArray "$PROFILES" "${BundleProfile}:Groups"))
    APP_EXTENSIONS_DATA_UUID=($(propertyToArray "$PROFILES" "${BundleProfile}:Extensions"))

    killall "$EXECUTABLE" 2> /dev/null
    
    backupData "$ACTIVE_SLICE"
    restoreData "$SLICE_NAME"

    property "$PROFILES" "ActiveSlice:${BUNDLE_ID}" -string "$SLICE_NAME"

    if [[ -z "$NO_LAUNCH" ]]; then
        activator send "$BUNDLE_ID"
    fi

    echo "Slice $SLICE_NAME is now active for app."

    exit 0
fi

if [ "$ACTION" == "clean" ]; then
    if ! propertyExist "$PROFILES" "BundleID:${APP_NAME}"; then
        echo "There is no saved data for $APP_NAME"
        exit 1
    fi

    BUNDLE_ID=$(property "$PROFILES" "BundleID:${APP_NAME}")

    property "$PROFILES" "ActiveSlice:${BUNDLE_ID}" -remove
    property "$PROFILES" "BundleID:${APP_NAME}" -remove
    property "$PROFILES" "Profile:${BUNDLE_ID}" -remove

    rm -rf "$MP_ROOT/$BUNDLE_ID"

    echo "Removed all slices for $APP_NAME"

    exit 0
fi

if [ "$ACTION" == "remove" ]; then
    if ! propertyExist "$PROFILES" "BundleID:${APP_NAME}"; then
        echo "There is no saved data for $APP_NAME"
        exit 1
    fi

    BUNDLE_ID=$(property "$PROFILES" "BundleID:${APP_NAME}")
    ACTIVE_SLICE=$(property "$PROFILES" "ActiveSlice:${BUNDLE_ID}")

    if [ "$ACTIVE_SLICE" == "$SLICE_NAME" ]; then
        echo "Slice $SLICE_NAME is currently active and cannot be removed. To remove this one, apply another slice first, or use 'original' action if no other slice exist."
        
        exit 1
    fi

    if [ "$SLICE_NAME" == "$ORIG_SLICE_NAME" ]; then
        echo "Original slice cannot be removed. Use 'clean' action to remove all slices for app."

        exit 1
    fi

    if ! hasSlice "$SLICE_NAME"; then
        echo "There is no slice named $SLICE_NAME for app."

        exit 1
    fi

    property "$PROFILES" "Profile:${BUNDLE_ID}:Slices" -arrayremove "$SLICE_NAME"

    rm -rf "$MP_ROOT/$BUNDLE_ID/slice.$SLICE_NAME"

    echo "Removed slice $SLICE_NAME for $APP_NAME"

    exit 0
fi
